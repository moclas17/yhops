<?phprequire_once('lib/Conexion.php');require_once('lib/Funciones.php');@session_start(); date_default_timezone_set(ObtenValor("SELECT Nombre FROM CelaZonaHoraria WHERE idCelaZonaHoraria=(SELECT Valor FROM CelaConfiguraci_on WHERE Nombre='CelaZonaHoraria')","Nombre"));//Obtenemos la configuración para el capcha.$captcha=ObtenValor("SELECT Valor FROM CelaConfiguraci_on WHERE Nombre='Captcha'","Valor");if($captcha==1){	include_once 'lib/securimage/securimage.php';	$securimage = new Securimage();	$Length = (int)ObtenValor("SELECT Valor FROM CelaConfiguraci_on WHERE Nombre='Tama_noCaptcha'", "Valor");}$editFormAction = $_SERVER['PHP_SELF'];  //Si ya hay un usuario registrado redireccionamos al escritorio if(isset($_SESSION['CELA_Usuario'.$_SESSION['CELA_Aleatorio']]) && $_SESSION['CELA_Usuario'.$_SESSION['CELA_Aleatorio']]!=""){ 	$loginGoTo="Escritorio.php"; 	header(sprintf("Location: Escritorio.php"));  } if((isset($_POST['CELA_insertar'])) && ($_POST['CELA_insertar'] == 'Formulario1')){	//Si esta incluida la libreria de captcha, se evalua.	$captcha==1? $success=$securimage->check($_POST['txtcaptcha']):$success=true;	if( $success == false){		$_SESSION['CaptchaFail']=1;		header("Location: index.php");	} 	else{ 		$usuario = ucfirst( strtolower($_POST['txtusuario'] ) );  		$contrasena = md5($_POST['txtcontrasena']); 		$MM_redirectLoginSuccess = "Escritorio.php";          		$MM_redirectLoginFailed = "index.php";		 $consulta_usuario = sprintf("SELECT c.idUsuario, c.Usuario, c.Contrase_na, c.EstadoActual, c.Rol, c1.Siglas FROM CelaUsuario c  INNER JOIN CelaRol c1 ON ( c.Rol = c1.idRol  )   WHERE c.Usuario  = '%s' AND			c.Contrase_na  = '%s'",  addslashes($usuario),  addslashes($contrasena)); 						//exit;		$resultado_usuario = $Conexion->query($consulta_usuario); 		$renglon_usuario = $resultado_usuario->fetch_assoc(); 		if( $resultado_usuario->num_rows==1 ){ // Si existe el usuario			if($renglon_usuario['EstadoActual'] == 1){				$_SESSION['CELA_Aleatorio'] = rand(100,999);				$_SESSION['CELA_Usuario'.$_SESSION['CELA_Aleatorio']] = $usuario; 				$_SESSION['CELA_CveUsuario'.$_SESSION['CELA_Aleatorio']] = $renglon_usuario['idUsuario']; 				$_SESSION['CELA_Rol'.$_SESSION['CELA_Aleatorio']] = $renglon_usuario['Siglas']; 				$_SESSION['CELA_CveRol'.$_SESSION['CELA_Aleatorio']] = $renglon_usuario['Rol']; 				$_SESSION['CELA_UltimoAcceso'.$_SESSION['CELA_Aleatorio']] = date("Y-n-j H:i:s");  				$_SESSION['CELA_Autentificado'.$_SESSION['CELA_Aleatorio']] = 'SI';    			 				// Registrar el nombre del sistema				$NombreSistema=ObtenValor("SELECT Valor FROM CelaConfiguraci_on WHERE Nombre ='NombreSistema'","Valor");				$_SESSION['CELA_NombreSistema'.$_SESSION['CELA_Aleatorio']] = $NombreSistema;				//Tabla de accesos 				$ConsultaLog = sprintf("INSERT INTO CelaAccesos ( idAcceso, FechaDeAcceso, idUsuario, Tabla, IdTabla, Acci_on ) VALUES ( %s, %s, %s, %s, %s, %s)",					GetSQLValueString( "NULL", "int"),					GetSQLValueString( date('Y-m-d H:i:s'), "varchar"),					GetSQLValueString( $_SESSION['CELA_CveUsuario'.$_SESSION['CELA_Aleatorio']], "int"),					GetSQLValueString( $_SESSION['CELA_NombreSistema'.$_SESSION['CELA_Aleatorio']], "varchar"),					GetSQLValueString( '', "int"),					GetSQLValueString( 1, "int"));				$ResultadoLog=$Conexion->query($ConsultaLog);				header("Location: " . $MM_redirectLoginSuccess ); 			}			else{				// EL usuario esta bloqueado o cancelado				$_SESSION['UserLock']=1;				header("Location: index.php");			}		}		else{			$_SESSION['LoginFail']=1;			header("Location: index.php");		}	} } ?>