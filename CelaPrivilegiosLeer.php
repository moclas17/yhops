<?phprequire_once('lib/Conexion.php');include ('lib/Funciones.php');include ('lib/Seguridad.php');if(!isset($_GET['rol'])){	header("location: CelaRolLeer.php");}$FormAction = $_SERVER['PHP_SELF'];if (isset($_SERVER['QUERY_STRING'])) {	$FormAction .= "?" . htmlentities($_SERVER['QUERY_STRING']);}if ( (isset($_POST["CelaPrivilegios"])) && ($_POST["CelaPrivilegios"] == "CelaPrivilegios")  ) {	//Eliminamos los privilegios del tipo de usuario OK	$ConcultaPrivilegios="DELETE FROM CelaPrivilegios WHERE RolDeUsuario =".$_POST['Rol']." AND Tabla=2";	$ResultadoPrivilegios=$Conexion->query($ConcultaPrivilegios);		$ConsultaMenu="		SELECT * FROM CelaFormulario			WHERE Ruta in (				SELECT Referencia FROM CelaMen_u					WHERE idMenu IN (						select Elemento from CelaPrivilegios where RolDeUsuario=".$_POST['Rol']." AND Tabla=1					) AND TipoDeElemento=1				)			ORDER BY idFormulario";	$ResultadoMenu=$Conexion->query($ConsultaMenu);	//obtenemos privilegios de los formularios y los asignamos	$i=0;	$consultaPrivilegio="select * from CelaPrivilegio where Nombre <> 'Menu' order by idPrivilegio";	$resultadoPrivilegio=$Conexion->query($consultaPrivilegio);	$Status=false;	while($registroPrivilegio=$resultadoPrivilegio->fetch_assoc()){		$PrivilegiosRol[$i]['idPrivilegio']=$registroPrivilegio['idPrivilegio'];		$PrivilegiosRol[$i]['Nombre']=$registroPrivilegio['Nombre'];		$PrivilegiosRol[$i]['Descripcion']=$registroPrivilegio['Descripci_on'];		$i++;	}	while($RegistroMenu= $ResultadoMenu->fetch_array()){		for($i = 0; $i < count($PrivilegiosRol); $i++){			if(isset($_POST[$PrivilegiosRol[$i]['Nombre'].$RegistroMenu["idFormulario"]]) && $_POST[$PrivilegiosRol[$i]['Nombre'].$RegistroMenu["idFormulario"]]==1){				//Insertamos el privilegio en la tabla				$onsultaInsertaPrivilegio="INSERT INTO CelaPrivilegios(idPrivilegios, Privilegio, Elemento, RolDeUsuario, Tabla) VALUES (NULL, ".$PrivilegiosRol[$i]['idPrivilegio'].", ".$RegistroMenu["idFormulario"].", ".$_POST['Rol'].", 2)";				if($resultadoInsertaPrivilegio=$Conexion->query($onsultaInsertaPrivilegio)){					$Status=true;					}				else{					$Status=false;				}			}			}	}	if($Status==true){		$Status="Success";	}	else{		$Status="Error";		$Error=$Conexion->error;	}}if(isset($_GET['rol'])){		$consultaFormulario="		SELECT * FROM CelaFormulario			WHERE Ruta in (				SELECT Referencia FROM CelaMen_u					WHERE idMenu IN (						select Elemento from CelaPrivilegios where RolDeUsuario=".$_GET['rol']." AND Tabla=1					) AND TipoDeElemento=1				)			ORDER BY idFormulario";	$resultadoFormulario=$Conexion->query($consultaFormulario);	$registroFormulario=$resultadoFormulario->fetch_assoc();	$registros=$resultadoFormulario->num_rows;	$contador=0;		$PrivilegiosRol=array();	$consultaPrivilegios="select * from CelaPrivilegio where Nombre <> 'Menu' order by idPrivilegio";	$resultadoPrivilegios=$Conexion->query($consultaPrivilegios);	$i=0;	while($registroPrivilegios=$resultadoPrivilegios->fetch_assoc()){		$PrivilegiosRol[$i]['idPrivilegio']=$registroPrivilegios['idPrivilegio'];		$PrivilegiosRol[$i]['Nombre']=$registroPrivilegios['Nombre'];		$PrivilegiosRol[$i]['Descripcion']=$registroPrivilegios['Descripci_on'];		$i++;	}		$Iconos=array('fa fa-plus','fa fa-trash-o','fa fa-search','fa fa-pencil','fa fa-file','fa fa-share','fa fa-eye');}else{	header("Location: CelaRolLeer.php");}?><!DOCTYPE html><html lang="es">	<?php include 'CELAHead.php'; ?>	<body>		<?php include 'CELAMenuHorizontal.php'; ?>		<div class="container-fluid">			<div class="row">			<?php include 'CELAMenuVertical.php'; ?>				<div id="main-container" class="<?php print $registrosMenu>0?'col-sm-offset-3 col-sm-9 col-md-offset-2 col-md-10':'col-sm-12 col-md-12'; ?> main">					<div class="row">						<?php include 'CELARuta.php'; ?>					</div>					<div class="row">						<div class="col-sm-12 col-md-12">						<div class="row panel panel-primary">							<div class="panel-heading">							<div class="row">								<div class="col-md-12">									<div class="box-header col-xs-6 text-left">										<strong>											<span style="font-size: 18pt;">Privilegios del Rol:&nbsp; <?php print ObtenValor("SELECT NombreDelRol FROM CelaRol WHERE idRol=".$_GET['rol']."","NombreDelRol"); ?></span>										</strong>									</div>									<div class="box-icon col-xs-6 text-right">										<a data-intro="Ayuda general" data-position="left" href="#" class="btn-help btn btn-default" title="Ayuda"><i class="fa fa-question"></i></a>									</div>								</div>							</div>							</div>					<?php						//if(isset($Privilegios['Leer']) && $Privilegios['Leer']==1){					?>							<div class="box-content panel-body" style="overflow-x: auto"><!--Content Row Body-->						 <?php							if(isset($Status) && $Status=="Error"){						?>								<div class="alert alert-danger" role="alert">									<p>										<i class="fa fa-times fa-lg"></i>&nbsp; Oops!... Ocurrio un error registrando el elemento, puede <a href="<?php print $FormAction; ?>" class="alert-link">volver a intentar</a> &oacute; <a href="Escritorio.php" class="alert-link">ir al escritorio</a>									</p>									<p><?php print $Error; ?></p>								</div>						<?php							}							else{								if(isset($Status) && $Status=="Success"){						?>									<div class="alert alert-success fade in alert-msn" role="alert">										<button class="close" data-dismiss="alert" type="button">											<span aria-hidden="true">&times;</span>											<span class="sr-only">Close</span>										</button>										<p>											<strong><i class="fa fa-check fa-lg"></i>&nbsp; Registro exitoso!</strong>&nbsp; Los privilegios se actualizar&oacute;n correctamente.										</p>									</div>						<?php								}						?>								<form class="form-horizontal" method="POST" name="CelaMen_uPrivilegios" id="CelaMen_uPrivilegios" action="<?php echo $FormAction; ?>">									<fieldset>										<div class="form-group last">											<div class="col-sm-offset-3 col-sm-9">												<button type="submit" class="btn btn-primary Guardar" data-loading-text="Guardando...">													<i class="fa fa-save"></i>&nbsp; Hacer Cambios												</button>												&nbsp;&nbsp;&nbsp;&nbsp;												<button type="reset" class="btn btn-default" onclick = "location.href='CelaRolLeer.php'" >																									<i class="fa fa-undo"></i>&nbsp; Cancelar												</button>											</div>										</div>										<span class="clearfix"></span>										<hr />										<div class="table-responsive" align="left">											<table id="Privilegios" class="table table-striped">												<thead>													<tr>														<th title="Selecciona todos los privilegios">															<div align="center">																Todos Los<br />Privilegios<br />																<input type="checkbox" id="All" />															</div>														</th>												<?php													for($i = 0; $i < count($PrivilegiosRol); $i++){												?>														<th title="<?php print $PrivilegiosRol[$i]['Descripcion']; ?>">															<div align="center">																<?php print $PrivilegiosRol[$i]['Nombre'];?> &nbsp;																<input class="Privilegio" type="checkbox" id="<?php print $PrivilegiosRol[$i]['Nombre'];?>"/>															</div>														</th>												<?php													}												?>														<th><div align="center">Nombre del Formulario</div></th>														<th><div align="center">Descripci&oacute;n</div></th>														<th><div align="center">Ruta del Formulario</div></th>													</tr>												</thead>												<tbody>									<?php										do{									?>													<tr>														<td>															<div align="center">																<input class="All Form" type="checkbox" value="1" name="<?php print $registroFormulario['idFormulario']; ?>" id="<?php print $registroFormulario['idFormulario']; ?>" />															</div>														</td>												<?php													for($i = 0; $i < count($PrivilegiosRol); $i++){												?>														<td>															<div align="center">																<input class="<?php print $PrivilegiosRol[$i]['Nombre']; ?> All Form_<?php print $registroFormulario['idFormulario']; ?>" type="checkbox" id="<?php print $PrivilegiosRol[$i]['Nombre'].$registroFormulario['idFormulario'];?>" name="<?php print $PrivilegiosRol[$i]['Nombre'].$registroFormulario['idFormulario'];?>" <?php print ObtenValor("SELECT idPrivilegios FROM CelaPrivilegios WHERE Elemento=".$registroFormulario['idFormulario']." AND RolDeUsuario=".$_GET['rol']." AND Privilegio=".$PrivilegiosRol[$i]['idPrivilegio']." AND Tabla=2","idPrivilegios")!='NULL'?'checked="checked"':''; ?> value="1"/>															</div>														</td>												<?php													}												?>														<td><div align="center"><?php print $registroFormulario['Nombre'] ?></div></td>														<td><div align="center"><?php print $registroFormulario['Descripci_on'] ?></div></td>														<td><div align="center"><?php print $registroFormulario['Ruta'] ?></div></td>													</tr>									<?php										}while($registroFormulario=$resultadoFormulario->fetch_assoc());									?>												</tbody>											</table>										</div>		                                <input type="hidden" name="Rol" value="<?php print $_GET['rol']; ?>">		                                <input type="hidden" name="CelaPrivilegios" value="CelaPrivilegios">										<span class="clearfix"></span>										<hr />																				<div class="form-group last">											<div class="col-sm-offset-3 col-sm-9">												<button type="submit" class="btn btn-primary Guardar" data-loading-text="Guardando...">													<i class="fa fa-save"></i>&nbsp; Hacer Cambios												</button>												&nbsp;&nbsp;&nbsp;&nbsp;												<button type="reset" class="btn btn-default" onclick = "location.href='CelaRolLeer.php'" >													<i class="fa fa-undo"></i>&nbsp; Cancelar												</button>											</div>										</div>									</fieldset>								</form>						<?php							}						?>							</div><!--End Content Row Body-->					<?php						//}					?>							<div class="panel-footer text-right">								<a class="btn btn-danger" href="<?php print isset($_SERVER['HTTP_REFERER'])?substr($_SERVER['HTTP_REFERER'],strripos($_SERVER['HTTP_REFERER'],"/")+1,strlen($_SERVER['HTTP_REFERER'])):'Escritorio.php'; ?>" title="ir atr&aacute;s"  data-intro="Regresa al formulario anterior" data-position="left"><i class="fa fa-arrow-left"></i>&nbsp; ir atr&aacute;s</a>							</div>						</div>						</div>					</div>					<hr>					<span class="clearfix"></span>					<?php include 'CELAPie.php'; ?>				</div>			</div>		</div>		<?php include 'CELAJavascript.php'; ?>		<script type="text/javascript">			$("#All").change(function(){				$(".All").each(function(){					$(this).prop('checked', $('#All').is(':checked')); 				});			});			$(".Privilegio").change(function(){				var privilegio=$(this).attr("id");				$("."+privilegio).each(function(){					$(this).prop('checked', $('#'+privilegio).is(':checked')); 				});			});			$(".Form").change(function(){				var formulario=$(this).attr("id");				$(".Form_"+formulario).each(function(){					$(this).prop('checked', $('#'+formulario).is(':checked')); 				});			});			$("#CelaMen_uPrivilegios").submit(function(e){				$(".Guardar").button('loading');				setTimeout(function(){					if(oForm['CelaMen_uPrivilegios'].valid()){						$("#CelaMen_uPrivilegios").submit();						return;					}					else{						$(".Guardar").button('reset');					}				},500);			});			$(document).ready(function(){				$(".alert-msn").fadeOut(10000);			});			</script>	</body></html>