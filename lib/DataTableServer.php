<?php	require_once('Conexion.php');	require_once('Funciones.php');		//inicia la variable de sesion	if (!isset($_SESSION)) {		session_start();	}		//Apartado de seguridad.	if ($_SESSION["CELA_Autentificado".$_SESSION['CELA_Aleatorio']] != "SI") {		header("Location: ../Salir.php");		exit();	}	if (!isset($_SESSION["CELA_CveUsuario".$_SESSION['CELA_Aleatorio']]) && !isset($_SESSION['CELA_Usuario'.$_SESSION['CELA_Aleatorio']])) {		header("Location: ../Salir.php");		exit();	}	$_DATA=json_decode(Decrypt(str_replace(' ','+',isset($_GET['params'])?$_GET['params']:$_POST['params']),$_SESSION['CELA_Aleatorio']),true);		//Obtiene los privilegios del usuario	$Privilegios = isset($_DATA['Privileges'])?$_DATA['Privileges']:ObtenPrivilegiosFormulario(isset($_GET['formulario'])?$_GET['formulario']:$_POST['formulario']);		$myTable = $_DATA['table'];	$myWhere = $_DATA['condition'];	$myIndex = $_DATA['index'];	$mySelect['alias']='';	$mySelect['where']='';		/**	* Obtenemos la tabla y las columnas de la consulta.	**/	//Separamos las columnas y buscamos si existe alguna consulta de reemplazo.	$Cols=explode("/*/",$_DATA['columns']);	$_DATA['columns']= str_replace("/as/"," as",str_replace("/*/",",",$_DATA['columns']));	$found=strripos($Cols[0],'/as/');	if($found===false){		//No se encontro consulta de sustitucion.		$mySelect['alias'].=$Cols[0];		$mySelect['where'].=str_replace("(","",str_replace(")","",$Cols[0]));	}	else{		//Se encontro una consulta de sustitucion, indexamos el alias como columna.		$Column=substr($Cols[0],$found+5,strlen($Cols[0]));		$mySelect['alias'].=$Column;		$Column=substr($Cols[0],0,$found);		$mySelect['where'].=$Column;	}	for($index = 1; $index < count($Cols); $index++){		$found=strripos($Cols[$index],'/as/');		if($found===false){			//No se encontro consulta de sustitucion.			$mySelect['alias'].="/*/".$Cols[$index];			$mySelect['where'].="/*/".str_replace("(","",str_replace(")","",$Cols[$index]));		}		else{			//Se encontro una consulta de sustitucion, indexamos el alias como columna.			$Column=substr($Cols[$index],$found+5,strlen($Cols[$index]));			$mySelect['alias'].="/*/".$Column;			$Column=substr($Cols[$index],0,$found);			$mySelect['where'].="/*/".$Column;		}	}			$aColumns = explode("/*/",$mySelect['alias']);	$wColumns = explode("/*/",$mySelect['where']);	/* Indice de la tabla (utilizado para una rápida y precisa cardinalidad) */	$sIndexColumn = $myIndex;		/* Tabla a ser procesada */	$sTable = $myTable;		/* 	 * Paginación	 */	$sLimit = "";	if ( isset( $_POST['iDisplayStart'] ) && $_POST['iDisplayLength'] != '-1' )	{		$sLimit = "LIMIT ".intval( $_POST['iDisplayStart'] ).", ".intval( $_POST['iDisplayLength'] );	}		/*	 * Ordenación	 */	 $sOrder = isset($_DATA['order']) && intval($_POST['sEcho'])==1?"ORDER BY ".$_DATA['order']." ":'';	 if ( isset( $_POST['iSortCol_0'] )){	 	if($sOrder==""){			$sOrder = "ORDER BY  ";			}else{			$sOrder .= " , ";		}				for ( $i=0 ; $i<intval( $_POST['iSortingCols'] ) ; $i++ ){			if ( $_POST[ 'bSortable_'.intval($_POST['iSortCol_'.$i]) ] == "true" ){				$sOrder .= "".$aColumns[ intval( $_POST['iSortCol_'.$i] ) ]." ".($_POST['sSortDir_'.$i]==='asc' ? 'asc' : 'desc') .", ";			}		}				$sOrder = substr_replace( $sOrder, "", -2 );		if ( $sOrder == "ORDER BY" ){			$sOrder = "";		}	}	if($sOrder==""){		$sOrder="ORDER BY ".$sIndexColumn." desc";	}			/*	 * Agrupados	 */	 $sGroup = isset($_DATA['group'])?"GROUP BY ".$_DATA['group']." ":'';			/* 	 * Busqueda.	 */	$sWhere = $myWhere;	if ( isset($_POST['sSearch']) && $_POST['sSearch'] != ""  ){		if ( $myWhere == "" ){			$sWhere = ' (';		}		else{			$sWhere .= ' AND (';		}		for ( $i=0 ; $i<count($wColumns) ; $i++ ){			if($wColumns[$i]!="''")				$sWhere .= ''.$wColumns[$i].' LIKE "%'.MysqlClear( $_POST['sSearch'] ).'%" OR ';		}		$sWhere = substr_replace( $sWhere, "", -3 );		$sWhere .= ')';	}	/* Filtro individual de las columnas */	for ( $i=0 ; $i<count($wColumns) ; $i++ ){		$Busqueda="";		if ( isset($_POST['bSearchable_'.$i]) && $_POST['bSearchable_'.$i] == "true" && $_POST['sSearch_'.$i] != '' ){			$Busqueda= $_POST['sSearch_'.$i];						if( ($Busqueda != 'nul' || $Busqueda != "") && $wColumns[$i]!="''" ) {				if ( $sWhere == "" ){					$sWhere = ' (';				}				else{					$sWhere .= ' AND (';				}				$sWhere .= ''.$wColumns[$i].' = "'.($Busqueda).'" )';			}		}	}		if(isset($_DATA['debug']) && $_DATA['debug']==1){		print $sQuery = '		SELECT SQL_CALC_FOUND_ROWS '.$sIndexColumn.', '.$_DATA['columns'].'		FROM   '.$sTable.' WHERE '.($sWhere==""?'1=1':$sWhere).'		'.$sGroup.'		'.$sOrder.'		'.$sLimit.'';				$rResult = $Conexion->query( $sQuery );		print_r($Conexion);		exit(0);	}	/*	 * Consulta SQL	 * Obtiene los datos a mostrar.	 */	$sQuery = '		SELECT SQL_CALC_FOUND_ROWS '.$sIndexColumn.', '.$_DATA['columns'].'		FROM   '.$sTable.' WHERE '.($sWhere==""?'1=1':$sWhere).'		'.$sGroup.'		'.$sOrder.'		'.$sLimit.'';	$rResult = $Conexion->query( $sQuery );	//print_r($Conexion);	/* Total de datos en limite */	$iFilteredTotal = ObtenValor("SELECT FOUND_ROWS() as Total","Total");		/* Total de datos en la tabla */	$iTotal = ObtenValor("SELECT COUNT(*) as Total		FROM ".$sTable." WHERE ".($myWhere==""?"1=1":$myWhere)."","Total");	/*	 * Respuesta del servidor.	 */	$output = array(		"sEcho" => intval($_POST['sEcho']),		"iTotalRecords" => $iTotal,		"iTotalDisplayRecords" => $iFilteredTotal,		"aaData" => array()	);	$renglon=0;		//Verificamos que no haya un alias para el indice.	if(strpos($sIndexColumn,'.')!==false){		$sIndexColumn=substr($sIndexColumn,strrpos($sIndexColumn,'.')+1,strlen($sIndexColumn));		}		//Verificamos que no haya un alias para la tabla.	if(strpos($myTable,' ')!==false){		$myTable=substr($myTable,0,stripos($myTable,' '));	}	//Se genera el arreglo con los datos obtenidos.	while ( $aRow = $rResult->fetch_array(MYSQLI_ASSOC) ){		$row = array();		$row['DT_RowClass']="";		$row['DT_RowId']="";		for ( $i=0 ; $i<count($aColumns) ; $i++ ){			if (isset($_DATA['extra'][$i]) && trim($aColumns[$i]) == "''"){				//Incluimos las columnas extras.				include("ExtraColumns.php");				//Columna de acciones				$actionColum=$Extra[$_DATA['extra'][$i]];				// Formato para una columna que no pertenece a la tabla				$row[$i] = $actionColum;			}			else{				if(isset($_DATA['render'][$i])){					//Incluimos las columnas con render.					include("RenderColumn.php");					//Formato para una columna con valor en la tabla pero de algun estilo en especial*					$actionColum=$Render[$_DATA['render'][$i]];					$row[$i] = $actionColum;				}				else{					if ( trim($aColumns[$i]) != '' && trim($aColumns[$i]) !="''"){						// Columnas con datos						$row[$i] = $aRow[trim($aColumns[$i])];					}					else{						$row[$i] = "&nbsp;";					}				}			}					}				if(isset($_DATA['rows'])){			//Incluimos las columnas con render.			include("RenderRow.php");			//Formato para una columna con valor en la tabla pero de algun estilo en especial*			$renderRow=$Rows[$_DATA['rows']];			$row['DT_RowClass'] = $renderRow;		}				$row['DT_RowId'] = $aRow[$sIndexColumn];		$row['DT_RowClass'] .= ' dataTableRow ';				$output['aaData'][] = $row;		$renglon++;	}	$response= array("aResponse"=>$output, "sQuery"=>Encrypt($sQuery,$_SESSION['CELA_Aleatorio']));	echo json_encode($response);?>